let url = [
"https://www.wine-searcher.com/merchant/11969",
"https://www.wine-searcher.com/merchant/66090",
"https://www.wine-searcher.com/merchant/27922",
"https://www.wine-searcher.com/merchant/6001",
"https://www.wine-searcher.com/merchant/51687",
"https://www.wine-searcher.com/merchant/40726",
"https://www.wine-searcher.com/merchant/36880",
"https://www.wine-searcher.com/merchant/59799",
"https://www.wine-searcher.com/merchant/36870",
"https://www.wine-searcher.com/merchant/14150",
"https://www.wine-searcher.com/merchant/128050",
"https://www.wine-searcher.com/merchant/19985",
"https://www.wine-searcher.com/merchant/19795",
"https://www.wine-searcher.com/merchant/1985",
"https://www.wine-searcher.com/merchant/115735",
"https://www.wine-searcher.com/merchant/60191",
"https://www.wine-searcher.com/merchant/58785",
"https://www.wine-searcher.com/merchant/22651",
"https://www.wine-searcher.com/merchant/7889",
"https://www.wine-searcher.com/merchant/61406",
"https://www.wine-searcher.com/merchant/73476",
"https://www.wine-searcher.com/merchant/25818",
"https://www.wine-searcher.com/merchant/21648",
"https://www.wine-searcher.com/merchant/7807",
"https://www.wine-searcher.com/merchant/36896",
"https://www.wine-searcher.com/merchant/114991",
"https://www.wine-searcher.com/merchant/136520",
"https://www.wine-searcher.com/merchant/115737",
"https://www.wine-searcher.com/merchant/115553",
"https://www.wine-searcher.com/merchant/117098",
"https://www.wine-searcher.com/merchant/20488",
"https://www.wine-searcher.com/merchant/20164",
"https://www.wine-searcher.com/merchant/17953",
"https://www.wine-searcher.com/merchant/11510",
"https://www.wine-searcher.com/merchant/140417",
"https://www.wine-searcher.com/merchant/22967",
"https://www.wine-searcher.com/merchant/39028",
"https://www.wine-searcher.com/merchant/124462",
"https://www.wine-searcher.com/merchant/138219",
"https://www.wine-searcher.com/merchant/36945",
"https://www.wine-searcher.com/merchant/39026",
"https://www.wine-searcher.com/merchant/37685",
"https://www.wine-searcher.com/merchant/50832",
"https://www.wine-searcher.com/merchant/26155",
"https://www.wine-searcher.com/merchant/123659",
"https://www.wine-searcher.com/merchant/58112",
"https://www.wine-searcher.com/merchant/70594",
"https://www.wine-searcher.com/merchant/10783",
"https://www.wine-searcher.com/merchant/133914",
"https://www.wine-searcher.com/merchant/21273",
"https://www.wine-searcher.com/merchant/26159",
"https://www.wine-searcher.com/merchant/63178",
"https://www.wine-searcher.com/merchant/94566",
"https://www.wine-searcher.com/merchant/55677",
"https://www.wine-searcher.com/merchant/20194",
"https://www.wine-searcher.com/merchant/63105",
"https://www.wine-searcher.com/merchant/15381",
"https://www.wine-searcher.com/merchant/70821",
"https://www.wine-searcher.com/merchant/75779",
"https://www.wine-searcher.com/merchant/66156",
"https://www.wine-searcher.com/merchant/77763",
"https://www.wine-searcher.com/merchant/13700",
"https://www.wine-searcher.com/merchant/19856",
"https://www.wine-searcher.com/merchant/67655",
"https://www.wine-searcher.com/merchant/57220",
"https://www.wine-searcher.com/merchant/13242",
"https://www.wine-searcher.com/merchant/14354",
"https://www.wine-searcher.com/merchant/115141",
"https://www.wine-searcher.com/merchant/123710",
"https://www.wine-searcher.com/merchant/13083",
"https://www.wine-searcher.com/merchant/21274",
"https://www.wine-searcher.com/merchant/20116",
"https://www.wine-searcher.com/merchant/38729",
"https://www.wine-searcher.com/merchant/52748",
"https://www.wine-searcher.com/merchant/50",
"https://www.wine-searcher.com/merchant/106026",
"https://www.wine-searcher.com/merchant/115196",
"https://www.wine-searcher.com/merchant/115193",
"https://www.wine-searcher.com/merchant/1307",
"https://www.wine-searcher.com/merchant/60562",
"https://www.wine-searcher.com/merchant/45953",
"https://www.wine-searcher.com/merchant/144625",
"https://www.wine-searcher.com/merchant/11469",
"https://www.wine-searcher.com/merchant/7155",
"https://www.wine-searcher.com/merchant/61631",
"https://www.wine-searcher.com/merchant/146609",
"https://www.wine-searcher.com/merchant/69287",
"https://www.wine-searcher.com/merchant/76246",
"https://www.wine-searcher.com/merchant/68680",
"https://www.wine-searcher.com/merchant/68679",
"https://www.wine-searcher.com/merchant/69326",
"https://www.wine-searcher.com/merchant/144627",
"https://www.wine-searcher.com/merchant/37063",
"https://www.wine-searcher.com/merchant/144630",
"https://www.wine-searcher.com/merchant/66879",
"https://www.wine-searcher.com/merchant/10504",
"https://www.wine-searcher.com/merchant/66234",
"https://www.wine-searcher.com/merchant/10493",
"https://www.wine-searcher.com/merchant/46020",
"https://www.wine-searcher.com/merchant/20610",
"https://www.wine-searcher.com/merchant/8482",
"https://www.wine-searcher.com/merchant/69285",
"https://www.wine-searcher.com/merchant/55489",
"https://www.wine-searcher.com/merchant/36479",
"https://www.wine-searcher.com/merchant/36484",
"https://www.wine-searcher.com/merchant/37066",
"https://www.wine-searcher.com/merchant/143353",
"https://www.wine-searcher.com/merchant/55471",
"https://www.wine-searcher.com/merchant/22054",
"https://www.wine-searcher.com/merchant/55469",
"https://www.wine-searcher.com/merchant/38296",
"https://www.wine-searcher.com/merchant/11606",
"https://www.wine-searcher.com/merchant/62008",
"https://www.wine-searcher.com/merchant/69284",
]


chrome.runtime.onMessage.addListener(function(request, sender, sendResponse){
    let count = 0;
    if(request.message == 'startscraping') {
        chrome.storage.sync.set({'items': 'Name,Mobile,Website Url \n'});
        chrome.runtime.sendMessage({message:"openurl",url:url[count],prevTabId:null,count:count})
    }
    if(request.message == 'getPageData'){
        let count = request.count;
        let name = mobile = websiteUrl = '';
        name = $('.merchant-title').text();
        mobile = $('span[itemprop="telephone"]').text();
        websiteUrl = $('.btn1-mp-website > a').attr('onmouseover');
        if(websiteUrl != undefined && websiteUrl != ''){
            websiteUrl = websiteUrl.replace('this.href=','');
            websiteUrl = websiteUrl.replace(/\'/g, '');
        }else{
            websiteUrl = '';
        }
        
        if(name == undefined || name == ''){
            $(document).find('.recaptcha-checkbox-border').click();
        }else{
            chrome.storage.sync.get(['items'], function(result) {
                let items = result.items
                items += name+','+mobile+','+websiteUrl+'\n'
                chrome.storage.sync.set({'items': items});
            });
            
            if(count < url.length){
                //setInterval(function(){ 
                    chrome.runtime.sendMessage({message:"openurl",url:url[count],prevTabId:request.tabId,count:count})
                //}, 5000);
            }else{
                chrome.runtime.sendMessage({message:"stopscraping",tabId:request.tabId})
            }          
        }
    }
    if(request.message == 'downloadscraping') {
        chrome.storage.sync.get(['items'], function(result) {
            csv = result.items;
            let hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = 'scrapData.csv';
            hiddenElement.click();
        });
    }
})
